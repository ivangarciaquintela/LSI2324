# PRACTICA 1 LSI
## Parte 1
<details>
  <summary>a) Configure su máquina virtual de laboratorio con los datos proporcionados por el profesor. Analice los ficheros básicos de configuración (interfaces, hosts, resolv.conf, nsswitch.conf, sources.list, etc.)</summary>

  Respuesta:

  1. Archivo de interfaces( /etc/network/interfaces):
     ```
     auto lo ens33 ens34
     iface lo inet loopback
     iface ens33 inet static
     	address 10.11.48.71
     	netmask 255.255.254.0
     	broadcast 10.11.49.255
     	network 10.11.48.0
     	gateway 10.11.48.1
     iface ens34 inet static
     	address 10.11.50.71
     	netmask 255.255.254.0
     	broadcast 10.11.51.255
     	network 10.11.50.0
     ```
  2. Archivo hosts (/etc/hosts): 
     ```
     127.0.0.1       localhost
     127.0.1.1       debian
     # The following lines are desirable for IPv6 capable hosts
     ::1     localhost ip6-localhost ip6-loopback
     ff02::1 ip6-allnodes
     ff02::2 ip6-allrouters
     ```

  3. Archivo resolv.conf:
     ```
     main udc.pri
     search udc.pri
     nameserver 10.8.12.49
     nameserver 10.8.12.50
     nameserver 10.8.12.47
     ```

  4. Archivo nsswitch.conf(/etc/nssiwtch.conf):
     ```
     passwd:         files systemd
     group:          files systemd
     shadow:         files
     gshadow:        files

     hosts:          files mdns4_minimal [NOTFOUND=return] dns myhostname
     networks:       files

     protocols:      db files
     services:       db files
     ethers:         db files
     rpc:            db files
     netgroup:       nis
     ```
   5. Archivo sources.list (/etc/apt/sources.list) :
      ```
      deb http://deb.debian.org/debian/ buster main
      deb-src http://deb.debian.org/debian/ buster main

      deb https://deb.debian.org/debian-security buster-security main contrib
      deb-src https://deb.debian.org/debian-security buster-security main contrib

      deb http://security.debian.org/debian-security buster/updates main
      deb-src http://security.debian.org/debian-security buster/updates main

      ```
</details>
<details>
  <summary>b)¿Qué distro y versión tiene la máquina inicialmente entregada?. Actualice su máquina a la última versión estable disponible.</summary>

  Respuesta:

  1. Mostramos la distro actual y su versión:
     ```console
     root@debian:/home/lsi# lsb_release -a
     Distributor ID:	Debian
     Description:	Debian GNU/Linux 10 (buster)
     Release:	10
     Codename:	buster
     ```
  2. Para actualizar (desde el usuario 'root'):
  ```console
   root@debian:/home/lsi# apt update -y && apt upgrade -y
   root@debian:/home/lsi# apt dist-upgrade
  ```
  3. Tras ello será necesario reemplazar el sources.list hacia la versión que queremos ,en este caso debian 12 (bookworm), para ello deberemos hacer este paso dos veces ya que primero deberíamos pasar por debian 11 (bullseye). El archivo quedará finalmente así (debian 12):
  ```
      deb https://ftp.debian.org/debian/ bookworm contrib main non-free non-free-firmware
      # deb-src https://ftp.debian.org/debian/ bookworm contrib main non-free non-free-firmware

      deb https://ftp.debian.org/debian/ bookworm-updates contrib main non-free non-free-firmware
      # deb-src https://ftp.debian.org/debian/ bookworm-updates contrib main non-free non-free-firmware

      deb https://ftp.debian.org/debian/ bookworm-proposed-updates contrib main non-free non-free-firmware
      # deb-src https://ftp.debian.org/debian/ bookworm-proposed-updates contrib main non-free non-free-firmwa>

      deb https://ftp.debian.org/debian/ bookworm-backports contrib main non-free non-free-firmware
      # deb-src https://ftp.debian.org/debian/ bookworm-backports contrib main non-free non-free-firmware

      deb https://security.debian.org/debian-security/ bookworm-security contrib main non-free non-free-firmwa>
      # deb-src https://security.debian.org/debian-security/ bookworm-security contrib main non-free non-free->
  ```
  4. Ejecutamos los siguientes comandos y lo tendremos actualizado:
   ```console
   root@debian:/home/lsi# apt update 
   root@debian:/home/lsi# apt upgrade --without-new-pkgs
   root@debian:/home/lsi# apt full-upgrade
   root@debian:/home/lsi# reboot
  ```
</details>
<details>
  <summary> c) Identifique la secuencia completa de arranque de una máquina basada en la distribución de referencia (desde la pulsación del botón de arranque hasta la pantalla de login). ¿Qué target por defecto tiene su máquina?. ¿Cómo podría cambiar el target de arranque?. ¿Qué targets tiene su sistema y en qué estado se encuentran?. ¿Y los services?. Obtenga la relación de servicios de su sistema y su estado. ¿Qué otro tipo de unidades existen?.</summary>

  1. Para ello primero ejecutaremos:
     ```console
     root@debian:/home/lsi# systemctl list-dependencies default.target
     ```
  2. Target por defecto es `graphical.target`, para cambiarlo debemos hacer:
     ```console
     root@debian:/home/lsi# systemctl set-default TARGET
     ```
  3. Los targets del sistema podemos obtenerlos usando el comando 'systemctl list-unit-files --type=target'
  
  4. Cambiaremos el target a 'multi-user.target' ya que el 'graphical.target' no lo necesitaremos :
     ```console
     root@debian:/home/lsi# systemctl set-default multi-user.target
     ```
  5. Para listar a los Servicios del sistema
     ```console
     root@debian:/home/lsi# systemctl list-unit-files --type=service
     ```
</details>
<details>
  <summary>d) Determine los tiempos aproximados de botado de su kernel y del userspace. Obtenga la relación de los tiempos de ejecución de los services de su sistema.</summary>

  1.  Para obtener tiempos aproximados de botado de kernel y userspace:
      ```console
      root@debian:/home/lsi# systemd-analyze
      Startup finished in 4.163s (kernel) + 9.272s (userspace) = 13.436s
      multi-user.target reached after 9.229s in userspace.
      ```
   2. Para tener los tiempo específicos de cada proceso en el boot:
   ```console
   root@debian:/home/lsi# systemd-analyze blame
	4.060s e2scrub_reap.service
	2.624s ifupdown-pre.service
	2.578s dev-sda1.device
	2.410s ModemManager.service
	2.381s NetworkManager.service
	2.356s apparmor.service
	2.127s networking.service
	1.121s user@1000.service
	 829ms systemd-journal-flush.service
	 821ms systemd-udev-trigger.service
	 789ms systemd-timesyncd.service
	 734ms systemd-journald.service
	 713ms systemd-udevd.service
	 670ms keyboard-setup.service
	 664ms polkit.service
	 646ms udisks2.service
	 574ms avahi-daemon.service
	 536ms NetworkManager-wait-online.service
	 526ms dbus.service
	 510ms systemd-logind.service
	 404ms systemd-binfmt.service
	 332ms systemd-tmpfiles-setup.service
	 310ms systemd-modules-load.service
	 274ms cups.service
	 241ms ssh.service
	 219ms rsyslog.service
	 205ms plymouth-start.service
	 195ms pulseaudio-enable-autospawn.service
	 190ms systemd-random-seed.service
	 188ms dev-mqueue.mount
	 188ms sys-kernel-debug.mount
	 187ms sys-kernel-tracing.mount
	 181ms wpa_supplicant.service
	 179ms dev-hugepages.mount
	 160ms systemd-sysusers.service
	 138ms modprobe@dm_mod.service
	 137ms systemd-tmpfiles-setup-dev.service
	 130ms upower.service
	 118ms systemd-update-utmp.service
	....
   ```	
</details>


<details>
  <summary>e) Investigue si alguno de los servicios del sistema falla. Pruebe algunas de las opciones del sistema de registro journald. Obtenga toda la información journald referente al proceso de botado de la máquina. ¿Qué hace el systemd-timesyncd?.</summary>

  1. Comprobar si algun servicio falla:
  ```console
root@debian:/home/lsi# systemctl list-unit-files --type=service --failed
UNIT FILE STATE PRESET

0 unit files listed.
  ```
  
  2. La sentencia `journalctl -u SERVICE` muestra los logs de un servicio:
  ```console
root@debian:/home/lsi# journalctl -u networking.service
sep 14 14:06:00 debian systemd[1]: Starting Raise network interfaces...
sep 14 14:06:01 debian systemd[1]: Started Raise network interfaces.
sep 15 13:38:40 debian systemd[1]: Stopping networking.service - Raise network interfaces...
sep 15 13:38:40 debian systemd[1]: networking.service: Deactivated successfully.
sep 15 13:38:40 debian systemd[1]: Stopped networking.service - Raise network interfaces.
-- Boot 75062fbef4144ed2a2d6367959cdd017 --
sep 15 13:39:11 debian systemd[1]: Starting networking.service - Raise network interfaces...
sep 15 13:39:13 debian systemd[1]: Finished networking.service - Raise network interfaces.
sep 19 13:47:44 debian systemd[1]: Stopping networking.service - Raise network interfaces...
sep 19 13:47:45 debian systemd[1]: networking.service: Deactivated successfully.
sep 19 13:47:45 debian systemd[1]: Stopped networking.service - Raise network interfaces.
-- Boot 253053f1f1b8440f8cef54317e5f0fd0 --
sep 19 13:48:05 debian systemd[1]: Starting networking.service - Raise network interfaces...
sep 19 13:48:07 debian systemd[1]: Finished networking.service - Raise network interfaces.
sep 28 16:44:30 debian systemd[1]: Stopping networking.service - Raise network interfaces...
sep 28 16:44:31 debian systemd[1]: networking.service: Deactivated successfully.
sep 28 16:44:31 debian systemd[1]: Stopped networking.service - Raise network interfaces.
-- Boot 0709ac47e67443d9a356976effa192f7 --
sep 28 16:44:52 debian systemd[1]: Starting networking.service - Raise network interfaces...
sep 28 16:44:54 debian systemd[1]: Finished networking.service - Raise network interfaces.

  ```
  3. El comando `journactl -b` muestra el log del boot actual:
  ```console
root@debian:/home/lsi# journalctl -b
sep 28 16:44:48 debian kernel: Linux version 6.1.0-12-amd64 (debian-kernel@lists.debian.org) (gcc-12 (De>
sep 28 16:44:48 debian kernel: Command line: BOOT_IMAGE=/boot/vmlinuz-6.1.0-12-amd64 root=UUID=4aaea9ef->
sep 28 16:44:48 debian kernel: Disabled fast string operations
sep 28 16:44:48 debian kernel: BIOS-provided physical RAM map:
sep 28 16:44:48 debian kernel: BIOS-e820: [mem 0x0000000000000000-0x000000000009f3ff] usable
sep 28 16:44:48 debian kernel: BIOS-e820: [mem 0x000000000009f400-0x000000000009ffff] reserved
sep 28 16:44:48 debian kernel: BIOS-e820: [mem 0x00000000000dc000-0x00000000000fffff] reserved
sep 28 16:44:48 debian kernel: BIOS-e820: [mem 0x0000000000100000-0x000000005feeffff] usable
sep 28 16:44:48 debian kernel: BIOS-e820: [mem 0x000000005fef0000-0x000000005fefefff] ACPI data
sep 28 16:44:48 debian kernel: BIOS-e820: [mem 0x000000005feff000-0x000000005fefffff] ACPI NVS
sep 28 16:44:48 debian kernel: BIOS-e820: [mem 0x000000005ff00000-0x000000005fffffff] usable
sep 28 16:44:48 debian kernel: BIOS-e820: [mem 0x00000000f0000000-0x00000000f7ffffff] reserved
sep 28 16:44:48 debian kernel: BIOS-e820: [mem 0x00000000fec00000-0x00000000fec0ffff] reserved
sep 28 16:44:48 debian kernel: BIOS-e820: [mem 0x00000000fee00000-0x00000000fee00fff] reserved
sep 28 16:44:48 debian kernel: BIOS-e820: [mem 0x00000000fffe0000-0x00000000ffffffff] reserved
sep 28 16:44:48 debian kernel: NX (Execute Disable) protection: active
sep 28 16:44:48 debian kernel: SMBIOS 2.7 present.
sep 28 16:44:48 debian kernel: DMI: VMware, Inc. VMware Virtual Platform/440BX Desktop Reference Platfor>
sep 28 16:44:48 debian kernel: vmware: hypercall mode: 0x00
sep 28 16:44:48 debian kernel: Hypervisor detected: VMware
sep 28 16:44:48 debian kernel: vmware: TSC freq read from hypervisor : 2294.471 MHz
sep 28 16:44:48 debian kernel: vmware: Host bus clock speed read from hypervisor : 66000000 Hz
sep 28 16:44:48 debian kernel: vmware: using clock offset of 9995438424 ns
sep 28 16:44:48 debian kernel: tsc: Detected 2294.471 MHz processor
sep 28 16:44:48 debian kernel: e820: update [mem 0x00000000-0x00000fff] usable ==> reserved
sep 28 16:44:48 debian kernel: e820: remove [mem 0x000a0000-0x000fffff] usable
sep 28 16:44:48 debian kernel: last_pfn = 0x60000 max_arch_pfn = 0x400000000
sep 28 16:44:48 debian kernel: x86/PAT: Configuration [0-7]: WB  WC  UC- UC  WB  WP  UC- WT  
sep 28 16:44:48 debian kernel: found SMP MP-table at [mem 0x000f6a80-0x000f6a8f]
sep 28 16:44:48 debian kernel: RAMDISK: [mem 0x320db000-0x35064fff]
sep 28 16:44:48 debian kernel: ACPI: Early table checksum verification disabled
sep 28 16:44:48 debian kernel: ACPI: RSDP 0x00000000000F6A10 000024 (v02 PTLTD )
sep 28 16:44:48 debian kernel: ACPI: XSDT 0x000000005FEF0284 00005C (v01 INTEL  440BX    06040000 VMW  0>
sep 28 16:44:48 debian kernel: ACPI: FACP 0x000000005FEFEE73 0000F4 (v04 INTEL  440BX    06040000 PTL  0>
sep 28 16:44:48 debian kernel: ACPI: DSDT 0x000000005FEF04C4 00E9AF (v01 PTLTD  Custom   06040000 MSFT 0>
sep 28 16:44:48 debian kernel: ACPI: FACS 0x000000005FEFFFC0 000040
sep 28 16:44:48 debian kernel: ACPI: FACS 0x000000005FEFFFC0 000040
sep 28 16:44:48 debian kernel: ACPI: BOOT 0x000000005FEF049C 000028 (v01 PTLTD  $SBFTBL$ 06040000  LTP 0>
sep 28 16:44:48 debian kernel: ACPI: APIC 0x000000005FEF044C 000050 (v01 PTLTD  ? APIC   06040000  LTP 0>
sep 28 16:44:48 debian kernel: ACPI: MCFG 0x000000005FEF0410 00003C (v01 PTLTD  $PCITBL$ 06040000  LTP 0>
sep 28 16:44:48 debian kernel: ACPI: SRAT 0x000000005FEF0380 000090 (v02 VMWARE MEMPLUG  06040000 VMW  0>
sep 28 16:44:48 debian kernel: ACPI: HPET 0x000000005FEF0348 000038 (v01 VMWARE VMW HPET 06040000 VMW  0>
sep 28 16:44:48 debian kernel: ACPI: WAET 0x000000005FEF0320 000028 (v01 VMWARE VMW WAET 06040000 VMW  0>
sep 28 16:44:48 debian kernel: ACPI: Reserving FACP table memory at [mem 0x5fefee73-0x5fefef66]
sep 28 16:44:48 debian kernel: ACPI: Reserving DSDT table memory at [mem 0x5fef04c4-0x5fefee72]
sep 28 16:44:48 debian kernel: ACPI: Reserving FACS table memory at [mem 0x5fefffc0-0x5fefffff]
sep 28 16:44:48 debian kernel: ACPI: Reserving FACS table memory at [mem 0x5fefffc0-0x5fefffff]
sep 28 16:44:48 debian kernel: ACPI: Reserving BOOT table memory at [mem 0x5fef049c-0x5fef04c3]
sep 28 16:44:48 debian kernel: ACPI: Reserving APIC table memory at [mem 0x5fef044c-0x5fef049b]
sep 28 16:44:48 debian kernel: ACPI: Reserving MCFG table memory at [mem 0x5fef0410-0x5fef044b]
sep 28 16:44:48 debian kernel: ACPI: Reserving SRAT table memory at [mem 0x5fef0380-0x5fef040f]
sep 28 16:44:48 debian kernel: ACPI: Reserving HPET table memory at [mem 0x5fef0348-0x5fef037f]
sep 28 16:44:48 debian kernel: ACPI: Reserving WAET table memory at [mem 0x5fef0320-0x5fef0347]
sep 28 16:44:48 debian kernel: SRAT: PXM 0 -> APIC 0x00 -> Node 0
sep 28 16:44:48 debian kernel: ACPI: SRAT: Node 0 PXM 0 [mem 0x00000000-0x0009ffff]
 ....
```
  
  4.`systemd-timesyncd` es un servicio del sistema que se usa para sincronizar el reloj local del sistema con un servidor NTP remoto. 
  
</details>

<details>
  <summary>f) Identifique y cambie los principales parámetros de su segundo interface de red (ens34). Configure un segundo interface lógico. Al terminar, déjelo como estaba.</summary>

  1. Comprobamos el estado inciial de ens34:
  ```console
root@debian:/home/lsi# ifconfig ens34
	ens34: flags=4163<UP,BROADCAST,RUNNING,MULTICAST>  mtu 1500
        inet 10.11.50.71  netmask 255.255.254.0  broadcast 10.11.51.255
        inet6 fe80::250:56ff:fe97:1dfa  prefixlen 64  scopeid 0x20<link>
        ether 00:50:56:97:1d:fa  txqueuelen 1000  (Ethernet)
        RX packets 713954  bytes 170064442 (162.1 MiB)
        RX errors 0  dropped 36510  overruns 0  frame 0
        TX packets 554  bytes 67000 (65.4 KiB)
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0
        device interrupt 16  base 0x2080  
  ```
  2. Configuramos el segundo interfaz de red:
     - Cambiamos el valor de MTU (Maximum Transmition Unit).
     - Cambiamos la dirección MAC de la interfaz
     - Configuramos la dirección IP y mascara de Red.

```console
root@debian:/home/lsi# ifconfig ens34 down
root@debian:/home/lsi# ifconfig ens34 mtu 1200
root@debian:/home/lsi# ifconfig ens34 hw ether 00:50:56:97:15:21 
root@debian:/home/lsi# ifconfig ens34 10.11.50.71 netmask 255.255.254.0
root@debian:/home/lsi# ifconfig ens34 up
root@debian:/home/lsi# ifconfig ens34
	ens34: flags=4163<UP,BROADCAST,RUNNING,MULTICAST>  mtu 1200
	        inet 10.11.50.71  netmask 255.255.254.0  broadcast 10.11.51.255
	        ether 00:50:56:97:15:21  txqueuelen 1000  (Ethernet)
	        RX packets 714258  bytes 170127584 (162.2 MiB)
	        RX errors 0  dropped 36557  overruns 0  frame 0
	        TX packets 569  bytes 68491 (66.8 KiB)
	        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0
	        device interrupt 16  base 0x2080
```
  3. Configuración de una interfaz lógica
```console
root@debian:/home/lsi# ifconfig ens34:1 192.168.1.1 netmask 255.255.255.0
root@debian:/home/lsi# ifconfig ens34:1 up
root@debian:/home/lsi# ifconfig
	ens33: flags=4163<UP,BROADCAST,RUNNING,MULTICAST>  mtu 1500
	        inet 10.11.48.71  netmask 255.255.254.0  broadcast 10.11.49.255
	        inet6 fe80::250:56ff:fe97:1521  prefixlen 64  scopeid 0x20<link>
	        ether 00:50:56:97:15:21  txqueuelen 1000  (Ethernet)
	        RX packets 222650  bytes 17130576 (16.3 MiB)
	        RX errors 0  dropped 36635  overruns 0  frame 0
	        TX packets 7822  bytes 685652 (669.5 KiB)
	        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0
	        device interrupt 19  base 0x2000  
	
	ens34: flags=4163<UP,BROADCAST,RUNNING,MULTICAST>  mtu 1200
	        inet 10.11.50.71  netmask 255.255.254.0  broadcast 10.11.51.255
	        ether 00:50:56:97:15:21  txqueuelen 1000  (Ethernet)
	        RX packets 714410  bytes 170173169 (162.2 MiB)
	        RX errors 0  dropped 36573  overruns 0  frame 0
	        TX packets 579  bytes 69641 (68.0 KiB)
	        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0
	        device interrupt 16  base 0x2080  
	
	ens34:1: flags=4163<UP,BROADCAST,RUNNING,MULTICAST>  mtu 1200
	        inet 192.168.1.1  netmask 255.255.255.0  broadcast 192.168.1.255
	        ether 00:50:56:97:15:21  txqueuelen 1000  (Ethernet)
	        device interrupt 16  base 0x2080  
	
	lo: flags=73<UP,LOOPBACK,RUNNING>  mtu 65536
	        inet 127.0.0.1  netmask 255.0.0.0
	        inet6 ::1  prefixlen 128  scopeid 0x10<host>
	        loop  txqueuelen 1000  (Local Loopback)
	        RX packets 144  bytes 12131 (11.8 KiB)
	        RX errors 0  dropped 0  overruns 0  frame 0
	        TX packets 144  bytes 12131 (11.8 KiB)
	        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0
  ```
  4. Al no hacer ningun cambio persistente al reboot se borrarán los cambios. Si queremos que persista configurarlo en el archivo `/etc/network/interfaces`.
 
</details>
<details>
  <summary>g) ¿Qué rutas (routing) están definidas en su sistema?. Incluya una nueva ruta estática a una determinada red.</summary>

  1.Las rutas definidas en el sistema podemos encontrarlas ejecutando el siguiente comando:
  ```console
root@debian:/home/lsi# ip route show
	default via 10.11.48.1 dev ens33 onlink 
	10.11.48.0/23 dev ens33 proto kernel scope link src 10.11.48.71 
	10.11.50.0/23 dev ens34 proto kernel scope link src 10.11.50.71 
	169.254.0.0/16 dev ens33 scope link metric 1000

root@debian:/home/lsi# route
	Kernel IP routing table
	Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
	default         _gateway        0.0.0.0         UG    0      0        0 ens33
	10.11.48.0      0.0.0.0         255.255.254.0   U     0      0        0 ens33
	10.11.50.0      0.0.0.0         255.255.254.0   U     0      0        0 ens34
	link-local      0.0.0.0         255.255.0.0     U     1000   0        0 ens33

  ```

  2. Añadimos una nueva ruta:
```console
root@debian:/home/lsi# ip route add 10.11.52.0/24 via 10.11.48.1
root@debian:/home/lsi# ip route show
default via 10.11.48.1 dev ens33 onlink 
10.11.48.0/23 dev ens33 proto kernel scope link src 10.11.48.71 
10.11.50.0/23 dev ens34 proto kernel scope link src 10.11.50.71 
10.11.52.0/24 via 10.11.48.1 dev ens33 
169.254.0.0/16 dev ens33 scope link metric 1000 
```
</details>

<details>
  <summary>h) En el apartado d) se ha familiarizado con los services que corren en su sistema. ¿Son necesarios todos ellos?. Si identifica servicios no necesarios, proceda adecuadamente. Una limpieza no le vendrá mal a su equipo, tanto desde el punto de vista de la seguridad, como del rendimiento.</summary>

  1. Elimino los siguientes servicios :

  - accounts-daemon.service : API para GNOME con las accounts, innecesario ya que solo utilizamos *ssh*
    ```console
    root@debian:/home/lsi# systemctl disable accounts-daemon.service
    	Removed "/etc/systemd/system/graphical.target.wants/accounts-daemon.service".
    root@debian:/home/lsi# systemctl mask accounts-daemon.service
    	Created symlink /etc/systemd/system/accounts-daemon.service → /dev/null.

    ```
  - alsa-restore.service : configurador de sonido.
    ```console
	root@debian:/home/lsi# systemctl disable alsa-restore.service
	root@debian:/home/lsi# systemctl mask alsa-restore.service
		Created symlink /etc/systemd/system/alsa-restore.service → /dev/null.
    ```
  - alsa-state.service : configurador de sonido
    ```console
    root@debian:/home/lsi# systemctl disable alsa-state.service
    root@debian:/home/lsi# systemctl mask alsa-state.service
	Created symlink /etc/systemd/system/alsa-state.service → /dev/null.
    ```
  - avahi-daemon.service : permite a dispositivos de red local comunicarse de manera automática.
    ```console
    root@debian:/home/lsi# systemctl disable avahi-daemon.service
	Removed "/etc/systemd/system/sockets.target.wants/avahi-daemon.socket".
	Removed "/etc/systemd/system/dbus-org.freedesktop.Avahi.service".
	Removed "/etc/systemd/system/multi-user.target.wants/avahi-daemon.service".
    root@debian:/home/lsi# systemctl mask avahi-daemon.service
	Created symlink /etc/systemd/system/avahi-daemon.service → /dev/null.
    ```
  - bluetooth.service : funcionalidad Bluetooth.
    ```console
    root@debian:/home/lsi# systemctl disable bluetooth.service
	Synchronizing state of bluetooth.service with SysV service script with /lib/systemd/systemd-sysv-install.
	Executing: /lib/systemd/systemd-sysv-install disable bluetooth
	Removed "/etc/systemd/system/dbus-org.bluez.service".
	Removed "/etc/systemd/system/bluetooth.target.wants/bluetooth.service".
    root@debian:/home/lsi# systemctl mask bluetooth.service
	Created symlink /etc/systemd/system/bluetooth.service → /dev/null.
    ```
  - bolt.service : administración de dispositivos periféricos.
    ```console
    root@debian:/home/lsi# systemctl disable bolt.service
    root@debian:/home/lsi# systemctl mask bolt.service
	Created symlink /etc/systemd/system/bolt.service → /dev/null.
    ```
  - cups.service : sistema de impresión.
    ```console
    root@debian:/home/lsi# systemctl disable cups.service
	Synchronizing state of cups.service with SysV service script with /lib/systemd/systemd-sysv-install.
	Executing: /lib/systemd/systemd-sysv-install disable cups
	Removed "/etc/systemd/system/sockets.target.wants/cups.socket".
	Removed "/etc/systemd/system/printer.target.wants/cups.service".
	Removed "/etc/systemd/system/multi-user.target.wants/cups.service".
	Removed "/etc/systemd/system/multi-user.target.wants/cups.path".
    root@debian:/home/lsi# systemctl mask cups.service
	Created symlink /etc/systemd/system/cups.service → /dev/null.
    ```
  - ModemManager.service
    ```console
    root@debian:/home/lsi# systemctl disable ModemManager.service
	Removed "/etc/systemd/system/dbus-org.freedesktop.ModemManager1.service".
	Removed "/etc/systemd/system/multi-user.target.wants/ModemManager.service".
    root@debian:/home/lsi# systemctl mask ModemManager.service
	Created symlink /etc/systemd/system/ModemManager.service → /dev/null.
    ```
  - open-vm-tools.service
    ```console
    root@debian:/home/lsi# systemctl disable open-vm-tools.service
	Synchronizing state of open-vm-tools.service with SysV service script with /lib/systemd/systemd-sysv-install.
	Executing: /lib/systemd/systemd-sysv-install disable open-vm-tools
	Removed "/etc/systemd/system/vmtoolsd.service".
	Removed "/etc/systemd/system/multi-user.target.wants/open-vm-tools.service".
    root@debian:/home/lsi# systemctl mask open-vm-tools.service
	Created symlink /etc/systemd/system/open-vm-tools.service → /dev/null.
    ```
  - power-profiles-daemon.service
    ```console
    root@debian:/home/lsi# systemctl disable power-profiles-daemon.service
	Removed "/etc/systemd/system/graphical.target.wants/power-profiles-daemon.service".
    root@debian:/home/lsi# systemctl mask power-profiles-daemon.service
	Created symlink /etc/systemd/system/power-profiles-daemon.service → /dev/null.
    ```
  - NetworkManager.service
    ```console
    root@debian:/home/lsi# systemctl mask NetworkManager.service
	Created symlink /etc/systemd/system/NetworkManager.service → /dev/null.
    ```
  - plymouth.service
    ```console
    root@debian:/home/lsi# systemctl disable plymouth.service
	Synchronizing state of plymouth.service with SysV service script with /lib/systemd/systemd-sysv-install.
	Executing: /lib/systemd/systemd-sysv-install disable plymouth
    root@debian:/home/lsi# systemctl mask plymouth.service
	Created symlink /etc/systemd/system/plymouth.service → /dev/null.
    ```
  - plymouth-log.service
    ```console
    root@debian:/home/lsi# systemctl disable plymouth-log.service
	Synchronizing state of plymouth-log.service with SysV service script with /lib/systemd/systemd-sysv-install.
	Executing: /lib/systemd/systemd-sysv-install disable plymouth-log
    root@debian:/home/lsi# systemctl mask plymouth-log.service
	Created symlink /etc/systemd/system/plymouth-log.service → /dev/null.

    ```
  - pulseaudio-enable-autospawn
  ```console
root@debian:/home/lsi# systemctl disable pulseaudio-enable-autospawn
	pulseaudio-enable-autospawn.service is not a native service, redirecting to systemd-sysv-install.
	Executing: /lib/systemd/systemd-sysv-install disable pulseaudio-enable-autospawn
root@debian:/home/lsi# systemctl mask pulseaudio-enable-autospawn
	Created symlink /etc/systemd/system/pulseaudio-enable-autospawn.service → /dev/null.
  ```
  - cups-browsed
   ```console
root@debian:/home/lsi# systemctl disable cups-browsed.service
	Synchronizing state of cups-browsed.service with SysV service script with /lib/systemd/systemd-sysv-install.
	Executing: /lib/systemd/systemd-sysv-install disable cups-browsed
	Removed "/etc/systemd/system/multi-user.target.wants/cups-browsed.service".
root@debian:/home/lsi# systemctl mask cups-browsed.service
	Created symlink /etc/systemd/system/cups-browsed.service → /dev/null.
   ```
  - 
</details>
<details>
  <summary>i) Diseñe y configure un pequeño “script” y defina la correspondiente unidad de tipo service para que se ejecute en el proceso de botado de su máquina.</summary>

  1.Creamos el archivo a ejecutar en el servicio en `/usr/local/bin/` :
  ```bash                                       
#!/bin/bash
echo "Last time: $(date)" > /home/lsi/logInicio
  ```
  2. Creamos el servicio en `/etc/systemd/system/notify-boot.service`:
  ```bash                            
[Unit]
Description=Custom service that notifies last time logged.
After=network.target

[Service]
Type=simple
Restart=on-failure
RestartSec=5s
User=lsi
ExecStart=notify --boot

[Install]
WantedBy=multi-user.target
  ```
  3. Por ultimo lo activamos:
  ```console
root@debian:/usr/local/bin# nano /etc/systemd/system/notify-boot.service
root@debian:/usr/local/bin# systemctl enable notify-boot.service
	Created symlink /etc/systemd/system/multi-user.target.wants/notify-boot.service → /etc/systemd/system/notify-boot.service.
   ```
  4. 

</details>
<details>
  <summary>j) Identifique las conexiones de red abiertas a y desde su equipo.</summary>

  1. Con el comando netstat -netua podemos obtener la información de la conexiones de red:
     - `-n`: Esta opción indica a netstat que muestre las direcciones y puertos en formato numérico en lugar de intentar resolver mombres de host y servicios a nombres legibles por humanos. Esto es útil para obtener información más rápida y precisa.
     - `-e`: Esta opción muestra estadísticas de Ethernet, incluyendo recuentos de errores y estadísticas de colisiones. Puede ser útil para diagnosticar problemas en la capa física de la red.
     - `-t`: Esta opción muestra estadísticas de TCP, incluyendo información sobre conexiones TCP activas.
     - `-u`: Esta opción muestra estadísticas de UDP, incluyendo información sobre conexiones UDP activas.
     - `-a`: Esta opción muestra todas las conexiones, tanto activas como inactivas.
```console
root@debian:/home/lsi# netstat -netua
	Active Internet connections (servers and established)
	Proto Recv-Q Send-Q Local Address           Foreign Address         State       User       Inode     
	tcp        0      0 0.0.0.0:22              0.0.0.0:*               LISTEN      0          15345     
	tcp        0    304 10.11.48.71:22          10.20.36.108:58126      ESTABLISHED 0          15640     
	tcp6       0      0 :::22                   :::*                    LISTEN      0          15356     
	udp        0      0 0.0.0.0:57264           0.0.0.0:*                           101        18536 
```
</details>

<details>
  <summary>k) Nuestro sistema es el encargado de gestionar la CPU, memoria, red, etc., como soporte a los datos y procesos. Monitorice en “tiempo real” la información relevante de los procesos del sistema y los recursos consumidos. Monitorice en “tiempo real” las conexiones de su sistema.</summary>

  1. Procesos en tiempo real:
     ```console
     root@debian:/home/lsi# top
	top - 16:19:02 up 21 min,  1 user,  load average: 0,00, 0,00, 0,00
	Tareas: 186 total,   1 running, 185 sleeping,   0 stopped,   0 zombie
	%Cpu(s):  0,0 us,  0,3 sy,  0,0 ni, 99,7 id,  0,0 wa,  0,0 hi,  0,0 si,  0,0 st 
	MiB Mem :   1463,2 total,    993,9 free,    382,6 used,    227,1 buff/cache     
	MiB Intercambio:   1534,0 total,   1534,0 free,      0,0 used.   1080,6 avail Mem 
	
	    PID USER      PR  NI    VIRT    RES    SHR S  %CPU  %MEM     TIME+ COMMAND                           
	    152 root      20   0       0      0      0 I   0,3   0,0   0:00.87 kworker/0:3-events_power_efficie+ 
	    802 lsi       20   0   18104   6964   5056 S   0,3   0,5   0:00.06 sshd                              
	   1064 root      20   0   11716   5368   3212 R   0,3   0,4   0:00.09 top                               
	      1 root      20   0  102232  12148   9168 S   0,0   0,8   0:01.44 systemd                           
	      2 root      20   0       0      0      0 S   0,0   0,0   0:00.00 kthreadd                          
	      3 root       0 -20       0      0      0 I   0,0   0,0   0:00.00 rcu_gp                            
	      4 root       0 -20       0      0      0 I   0,0   0,0   0:00.00 rcu_par_gp     
       ....
     ```
  2. Conexiones en tiempo real :
     ```console
    root@debian:/home/lsi# netstat -netuac
	Active Internet connections (servers and established)
	Proto Recv-Q Send-Q Local Address           Foreign Address         State       User       Inode     
	tcp        0      0 0.0.0.0:22              0.0.0.0:*               LISTEN      0          15345     
	tcp        0    356 10.11.48.71:22          10.20.36.108:58126      ESTABLISHED 0          15640     
	tcp6       0      0 :::22                   :::*          
     ```
  
</details>

<details>
  <summary>l) Un primer nivel de filtrado de servicios los constituyen los tcp-wrappers. Configure el tcp-wrapper de su sistema (basado en los ficheros hosts.allow y hosts.deny) para permitir conexiones SSH a un determinado conjunto de IPs y denegar al resto. ¿Qué política general de filtrado ha aplicado?. ¿Es lo mismo el tcp-wrapper que un firewall?. Procure en este proceso no perder conectividad con su máquina. No se olvide que trabaja contra ella en remoto por ssh.</summary>

  1. El sistema comprueba el archivo `/etc/hosts.allow` para las conexiones tcp:
```bash
    # /etc/hosts.allow: list of hosts that are allowed to access the system.
    #                   See the manual pages hosts_access(5) and hosts_options(5).
    #
    # Example:    ALL: LOCAL @some_netgroup
    #             ALL: .foobar.edu EXCEPT terminalserver.foobar.edu
    #
    # If you're going to protect the portmapper use the name "rpcbind" for the
    # daemon name. See rpcbind(8) and rpc.mountd(8) for further information.
```
  2. Lo configuramos para que quede de la siguiente manera :
  ```bash
# /etc/hosts.allow: list of hosts that are allowed to access the system.
#                   See the manual pages hosts_access(5) and hosts_options(5).
#
# Example:    ALL: LOCAL @some_netgroup
#             ALL: .foobar.edu EXCEPT terminalserver.foobar.edu
#
# If you're going to protect the portmapper use the name "rpcbind" for the
# daemon name. See rpcbind(8) and rpc.mountd(8) for further information.
#

#localhost + Maquina Mateo
sshd: 127.0.0.1, 10.11.48.183, 10.11.50.183: spawn echo `/bin/date`\: Intento de conexión de %a a %A [PERMITIDO] >> /home/lsi/logssh

#VPN
sshd: 10.30.8.0/255.255.248.0 :  spawn echo `/bin/date`\: Intento de conexión (VPN) de %a a %A [PERMITIDO] >> /home/lsi/logssh

#EDUROAM
sshd: 10.20.32.0/255.255.258.0: spawn echo `/bin/date`\: Intento de conexión (eduroam) de %a a %A [PERMITIDO] >> /home/lsi/logssh
  ```
  3. Si la IP que se intenta conectar a la máquina, no se encuentra en el archivo host.allow, se comprueba si se deniega en `/etc/hosts.deny` :
  ```bash
# /etc/hosts.deny: list of hosts that are _not_ allowed to access the system.
#                  See the manual pages hosts_access(5) and hosts_options(5).
#
# Example:    ALL: some.host.name, .some.domain
#             ALL EXCEPT in.fingerd: other.host.name, .other.domain
#
# If you're going to protect the portmapper use the name "rpcbind" for the
# daemon name. See rpcbind(8) and rpc.mountd(8) for further information.
#
# The PARANOID wildcard matches any host whose name does not match its
# address.
#
# You may wish to enable this to ensure any programs that don't
# validate looked up hostnames still leave understandable logs. In past
# versions of Debian this has been the default.
# ALL: PARANOID

ALL: ALL: spawn echo `bin/date`\: Intento de conexión %a a %A [DENEGADA] >> /home/lsi/logssh
  ```
> Si no coincide con ninguna IP en el `hosts.deny` entonces de permite el acceso por defecto, por lo que denegamos todas las conexiones para que solo se acepten las que están en `hosts.allow`. 

- TCPWrapper no es lo mismo que un *firewall*, pero trabaja de una forma similar en la capa 7.

</details>
<details>
  <summary>m) Existen múltiples paquetes para la gestión de logs (syslog, syslog-ng, rsyslog). Utilizando el rsyslog pruebe su sistema de log local. Pruebe también el journald.</summary>

  1. Con el comando logger podemos registrar logs en rsyslog:
```console
root@debian:/home/lsi# logger 'Prueba 1'
root@debian:/home/lsi# logger 'Prueba 2'
root@debian:/home/lsi# tail -2 /var/log/syslog
	2023-10-03T17:10:52.632834+02:00 debian root: Prueba 1
	2023-10-03T17:10:54.860316+02:00 debian root: Prueba 2
```
> Con tail -X podemos var los ultimas X lineas del archivo

 2.  Con `journalctl`:
```console
root@debian:/home/lsi# echo "Este es un mensaje de prueba para journald" | systemd-cat
root@debian:/home/lsi# journalctl -n
	oct 03 17:16:43 debian systemd-timesyncd[637]: Timed out waiting for reply from 158.227.98.15:123 (3.deb>
	oct 03 17:16:53 debian systemd-timesyncd[637]: Timed out waiting for reply from 178.215.228.24:123 (3.de>
	oct 03 17:17:01 debian CRON[957]: pam_unix(cron:session): session opened for user root(uid=0) by (uid=0)
	oct 03 17:17:01 debian CRON[958]: (root) CMD (cd / && run-parts --report /etc/cron.hourly)
	oct 03 17:17:01 debian CRON[957]: pam_unix(cron:session): session closed for user root
	oct 03 17:17:29 debian systemd[1]: Starting systemd-tmpfiles-clean.service - Cleanup of Temporary Direct>
	oct 03 17:17:30 debian systemd[1]: systemd-tmpfiles-clean.service: Deactivated successfully.
	oct 03 17:17:30 debian systemd[1]: Finished systemd-tmpfiles-clean.service - Cleanup of Temporary Direct>
	oct 03 17:17:30 debian systemd[1]: run-credentials-systemd\x2dtmpfiles\x2dclean.service.mount: Deactivat>
	oct 03 17:17:31 debian cat[966]: Este es un mensaje de prueba para journald
```
</details>
<details>
  <summary>n) Configure IPv6 6to4 y pruebe ping6 y ssh sobre dicho protocolo. ¿Qué hace su tcp-wrapper en las conexiones ssh en IPv6? Modifique su tcp-wapper siguiendo el criterio del apartado h).¿Necesita IPv6?. ¿Cómo se deshabilita IPv6 en su equipo?</summary>

  1. Para levantar el tunel ipv6 debemos configurar el archivo `/etc/network/interfaces`:
```bash
# This file describes the network interfaces available on your system
# and how to activate them. For more information, see interfaces(5).
#source /etc/network/interfaces.d/*
# The loopback network interface
auto lo ens33 ens34
iface lo inet loopback
iface ens33 inet static
	address 10.11.48.71
	netmask 255.255.254.0
	broadcast 10.11.49.255
	network 10.11.48.0
	gateway 10.11.48.1

iface ens34 inet static
	address 10.11.50.71
	netmask 255.255.254.0
	broadcast 10.11.51.255
	network 10.11.50.0

#ipv6
auto 6to4
iface 6to4 inet6 v4tunnel
	pre-up modprobe ipv6
	address 2002:a0b:3047::1
	netmask 16
	gateway ::10.11.48.1
	endpoint any
	local 10.11.48.71
```
  2. Se edita el archivo `/etc/host.allow` para permitir las conexiones IPv6 de mi máquina y de mi compañero:
```bash
# /etc/hosts.allow: list of hosts that are allowed to access the system.
#                   See the manual pages hosts_access(5) and hosts_options(5).
#
# Example:    ALL: LOCAL @some_netgroup
#             ALL: .foobar.edu EXCEPT terminalserver.foobar.edu
#
# If you're going to protect the portmapper use the name "rpcbind" for the
# daemon name. See rpcbind(8) and rpc.mountd(8) for further information.
#

#localhost + Maquina Mateo
#sshd: 127.0.0.1, 10.11.48.183, 10.11.50.183: spawn echo `/bin/date`\:Intento de conexión de %a a %A [PERMITIDO] >> /home/lsi/logssh

#VPN
#sshd: 10.30.8.0/255.255.248.0:  spawn echo `/bin/date`\:Intento de conexión (VPN) de %a a %A [PERMITIDO] >> /home/lsi/logssh

# local
sshd: 127.0.0.1, 10.11.48.183, 10.11.50.183: spawn echo `/bin/date`\: conexión local de %a a %A [PERMITIDO] >> /home/lsi/logssh

# vpn udc:
sshd: 10.30.8.0/21: spawn echo `/bin/date`\: conexión por VPN de %a a %A [PERMITIDO] >> /home/lsi/logssh

# eduroam:
sshd: 10.20.32.0/255.255.248.0: spawn echo `/bin/date`\: conexión eduroam de %a a %A [PERMITIDO] >> /home/lsi/logssh

#IPV6
sshd: [2002:a0b:30b7::1]/48, [2002:a0b:3047::1]/48: spawn echo `/bin/date`\: conexión IPv6 de %a a %A [PERMITIDO] >> /home/lsi/logssh

```
  4. Para deshabilitar temporalmente IPv6 debes ir al siguiente archivo `/etc/sysctl.conf`:
```bash
#
# /etc/sysctl.conf - Configuration file for setting system variables
# See /etc/sysctl.d/ for additional system variables.
# See sysctl.conf (5) for information.
#

#kernel.domainname = example.com

# Uncomment the following to stop low-level messages on console
#kernel.printk = 3 4 1 3

###################################################################
# Functions previously found in netbase
#

# Uncomment the next two lines to enable Spoof protection (reverse-path filter)
# Turn on Source Address Verification in all interfaces to
# prevent some spoofing attacks
#net.ipv4.conf.default.rp_filter=1
#net.ipv4.conf.all.rp_filter=1

# Uncomment the next line to enable TCP/IP SYN cookies
# See http://lwn.net/Articles/277146/
# Note: This may impact IPv6 TCP sessions too
#net.ipv4.tcp_syncookies=1

# Uncomment the next line to enable packet forwarding for IPv4
#net.ipv4.ip_forward=1

# Uncomment the next line to enable packet forwarding for IPv6
#  Enabling this option disables Stateless Address Autoconfiguration
#  based on Router Advertisements for this host
#net.ipv6.conf.all.forwarding=1


###################################################################
# Additional settings - these settings can improve the network
# security of the host and prevent against some network attacks
# including spoofing attacks and man in the middle attacks through
# redirection. Some network environments, however, require that these
# settings are disabled so review and enable them as needed.
#
# Do not accept ICMP redirects (prevent MITM attacks)
#net.ipv4.conf.all.accept_redirects = 0
#net.ipv6.conf.all.accept_redirects = 0
# _or_
# Accept ICMP redirects only for gateways listed in our default
# gateway list (enabled by default)
# net.ipv4.conf.all.secure_redirects = 1
#
# Do not send ICMP redirects (we are not a router)
#net.ipv4.conf.all.send_redirects = 0
#
# Do not accept IP source route packets (we are not a router)
#net.ipv4.conf.all.accept_source_route = 0
#net.ipv6.conf.all.accept_source_route = 0
#
# Log Martian Packets
#net.ipv4.conf.all.log_martians = 1
#

###################################################################
# Magic system request Key
# 0=disable, 1=enable all, >1 bitmask of sysrq functions
# See https://www.kernel.org/doc/html/latest/admin-guide/sysrq.html
# for what other values do
#kernel.sysrq=438

#Descomenta las siguientes lineas para deshabilitar IPv6
#Tras descomentar ejecute sysctl -p para aplicar cambios
net.ipv6.conf.all.disable_ipv6 = 1
net.ipv6.conf.default.disable_ipv6 = 1
```
  5. Tras ello ejecutamos el siguiente comando:
```console
root@debian:/home/lsi# sysctl -p
	net.ipv6.conf.all.disable_ipv6 = 1
	net.ipv6.conf.default.disable_ipv6 = 1
```
  6. Si lo quisiesemos hacer de forma permanente :
     - Deberíamos ir a `/etc/default/grub`

     - Y en la linea GRUB_CMDLINE_LINUX ponemos :
       ```bash
       GRUB_CMDLINE_LINUX="ipv6.disable=1"
       ```
     - Luego hacemos `update-grub` y por último `reboot`
  > THC-IPv6 (The Hacker's Choice IPv6) es una suite de herramientas de seguridad de red diseñada para la evaluación de seguridad y pruebas de penetración en redes IPv6. Fue desarrollada por el grupo The Hacker's Choice (THC) y está destinada a proporcionar a los profesionales de seguridad y a los investigadores en seguridad una serie de herramientas para evaluar la seguridad de implementaciones de IPv6 y descubrir posibles vulnerabilidades. Algunas de las herramientas y módulos más conocidos de THC-IPv6 incluyen:
 > - THC-IPv6 Attack Toolkit: Esta es una colección de herramientas que permiten realizar ataques y pruebas de seguridad en redes IPv6. Incluye módulos para la realización de ataques de inundación, ataques de redirección de ruta, ataques de suplantación y más.
 > - Parasite6: Una herramienta que permite el envenenamiento de la caché IPv6 de un objetivo, lo que puede resultar en ataques de suplantación y redirección de tráfico.
 > - Fake_router6: Esta herramienta permite simular ser un enrutador IPv6 malicioso y anunciar rutas falsas, lo que puede llevar a ataques de hombre en el medio y redirección de tráfico.
 > - Redir6: Una herramienta que se utiliza para realizar ataques de redirección de tráfico en redes IPv6.
>
> Es importante destacar que THC-IPv6 es una suite de herramientas destinada a ser utilizada por profesionales de seguridad y expertos en pruebas de penetración en entornos controlados y con el permiso del propietario de la red. El objetivo principal es ayudar a identificar debilidades y vulnerabilidades en implementaciones IPv6 y en la seguridad de las redes que utilizan este protocolo.

</details>


## Parte 2

<details>
	<summary>a) En colaboración con otro alumno de prácticas, configure un servidor y un cliente NTPSec básico</summary>
	
1. Primero debemos instalar el paquete ntp:
```console
root@debian:/etc# apt install ntp
```
2. Luego modificaremos el archivo `/etc/ntpsec/ntp.conf` :
```bash
# /etc/ntpsec/ntp.conf, configuration for ntpd; see ntp.conf(5) for help

driftfile /var/lib/ntpsec/ntp.drift
leapfile /usr/share/zoneinfo/leap-seconds.list

# To enable Network Time Security support as a server, obtain a certificate
# (e.g. with Let's Encrypt), configure the paths below, and uncomment:
# nts cert CERT_FILE
# nts key KEY_FILE
# nts enable

# You must create /var/log/ntpsec (owned by ntpsec:ntpsec) to enable logging.
#statsdir /var/log/ntpsec/
#statistics loopstats peerstats clockstats
#filegen loopstats file loopstats type day enable
#filegen peerstats file peerstats type day enable
#filegen clockstats file clockstats type day enable

# This should be maxclock 7, but the pool entries count towards maxclock.
tos maxclock 11

# Comment this out if you have a refclock and want it to be able to discipline
# the clock by itself (e.g. if the system is not connected to the network).
tos minclock 4 minsane 3

# Specify one or more NTP servers.

# Public NTP servers supporting Network Time Security:
# server time.cloudflare.com nts

# pool.ntp.org maps to about 1000 low-stratum NTP servers.  Your server will
# pick a different set every time it starts up.  Please consider joining the
# pool: <https://www.pool.ntp.org/join.html>
pool 0.debian.pool.ntp.org iburst
pool 1.debian.pool.ntp.org iburst
pool 2.debian.pool.ntp.org iburst
pool 3.debian.pool.ntp.org iburst

#Configuracion servidor
#server 127.127.1.0 minpoll 4
#fudge 127.127.1.0 stratum 0

#Configuracion cliente
server 10.11.48.183 minpoll 4
fudge 127.127.1. stratum


# Access control configuration; see /usr/share/doc/ntpsec-doc/html/accopt.html
# for details.
#
# Note that "restrict" applies to both servers and clients, so a configuration
# that might be intended to block requests from certain clients could also end
# up blocking replies from your own upstream servers.

# By default, exchange time with everybody, but don't allow configuration.
#restrict default kod nomodify nopeer noquery limited

#Para servidor
#restrict default ignore
#restrict 10.11.48.183 nomodify nopeer notrap

# Local users may interrogate the ntp server more closely.
restrict 127.0.0.1
restrict ::1

#Para cliente
restrict source notrap nomodify noquery
```
3. Una vez actualizado el archivo, restart el servicio:
```console
root@debian:/home/lsi# systemctl restart ntp
```
4. Comprobamos que funcione correctamente:
```console

``` 
</details>

<details>
	<summary>b) Cruzando los dos equipos anteriores, configure con rsyslog un servidor y un cliente de logs.</summary>
	
1. Primero editamos el archivo `/etc/rsyslog.conf`:
```bash
# For more information install rsyslog-doc and see
# /usr/share/doc/rsyslog-doc/html/configuration/index.html


#################
#### MODULES ####
#################

module(load="imuxsock") # provides support for local system logging
module(load="imklog")   # provides kernel logging support
#module(load="immark")  # provides --MARK-- message capability

# provides UDP syslog reception
#module(load="imudp")
#input(type="imudp" port="514")

# provides TCP syslog reception
#Descomentar si eres SERVER
#module(load="imtcp")
#input(type="imtcp" port="514")


###########################
#### GLOBAL DIRECTIVES ####
###########################

#Configuracion SERVER: para aceptar solo mensajes del compañero
#$AllowedSender TCP 127.0.0.1, 10.11.48.183

#
# Set the default permissions for all log files.
#
$FileOwner root
$FileGroup adm
$FileCreateMode 0640
$DirCreateMode 0755
$Umask 0022

#
# Where to place spool and state files
#
$WorkDirectory /var/spool/rsyslog

#
# Include all config files in /etc/rsyslog.d/
#
$IncludeConfig /etc/rsyslog.d/*.conf

#SERVIDOR : Template para guardar los registros de log
#$template remote, "var/log/rsyslog-server/%fromhost-ip%/%programename%.log
#*.* ?remote
#& stop

###############
#### RULES ####
###############

#
# Log anything besides private authentication messages to a single log file
#
*.*;auth,authpriv.none          -/var/log/syslog

#
# Log commonly used facilities to their own log file
#
auth,authpriv.*                 /var/log/auth.log
cron.*                          -/var/log/cron.log
kern.*                          -/var/log/kern.log
mail.*                          -/var/log/mail.log
user.*                          -/var/log/user.log

#
# Emergencies are sent to everybody logged in.
#
*.emerg                         :omusrmsg:*


# Client:

# Old Syntax (deprecated)

#$ActionQueueType LinkedList
#$ActionQueueFileName /var/log/rsyslog-queue
#$ActionQueueSaveOnShutdown on
#$ActionResumeRetryCount -1
#*.* @@10.11.48.183:514

# New Syntax

*.* action(
       type="omfwd"
       target="10.11.48.183"
       port="514"
       protocol="tcp"
       action.resumeRetryCount="-1"
       queue.type="linkedlist"
       queue.filename="/var/log/rsyslog-queue"
       queue.saveOnShutdown="on"
)

```
2. Reiniciamos el servicio :
```console
root@debian:/home/lsi# systemctl restart rsyslog.service
```
3. Y comprobamos haciendo logger:
```console
root@debian:/home/lsi# logger "PRUEBA CLIENTE A SERVER MATEO"
```
4. Desde el servidor:
```console
root@debian:/home/lsi# cat /var/log/rsyslog-server/10.11.48.71/root.log
2023-10-04T18:16:18+02:00 debian root: PRUEBA CLIENTE A SERVER MATEO
```
 </details>

<details>
	<summary>c) Haga todo tipo de propuestas sobre los siguientes aspectos.: ¿Qué problemas de seguridad identifica en los dos apartados anteriores?. ¿Cómo podría solucionar los problemas identificados?</summary>
	
- En `rsyslog` cualquiera podría enviar logs al servidor y llenar el disco. Además, los logs van sin cifrar por la red; cualquiera podría ver o modificar sus contenidos con un ataque MitM (Man in the Middle). También podrían hacer al servidor un \[D\]DOS.
  
- NTP trabaja sobre UDP; también es posible un \[D\]DOS haciendo IP Spoofing.

- Solución: 

	- Certificados TLS. Con estos certificados entre cliente y servidor podríamos asegurar la autenticidad del cliente y la confidencialidad e integridad de los datos. 

	- Podríamos asegurar la conectividad al puerto mediante *firewall* y mecanismos en capas inferiores
</details>

<details>
<summary>d) En la plataforma de virtualización corren, entre otros equipos, más de 200 máquinas virtuales para LSI. Como los recursos son limitados, y el disco duro también, identifique todas aquellas acciones que pueda hacer para reducir el espacio de disco ocupado.</summary>

- `df -H`: Muestra información sobre el almacenamiento de los sistemas de ficheros montados en la máquina.

-  `apt autoclean`: Elimina de la caché los paquetes de versiones antiguas e innecesarias.

- `apt clean`: Elimina **todos** los paquetes de la caché.

- `apt autoremove`: Elimina aquellos paquetes perdidos, generalmente instalados como dependencias de otras instalaciones, que ya no son necesarios.

- `apt --purge autoremove`: La opción `--purge` permite otras llamadas de *apt* para borrar también archivos de configuración y demás.

- Borrar man: `apt remove --purge man-db`

- Borrar imágenes kernel antiguas:

	- `uname -r`: Muestra kernel actual.

	- `dpkg --list | grep linux-image`: Muestra los kernels que tenemos en el sistema.

	- `apt-get --purge remove linux-image-4.......` Elimina un kernel en específico.
```console
root@debian:/home/lsi# df -H
S.ficheros     Tamaño Usados  Disp Uso% Montado en
udev             739M      0  739M   0% /dev
tmpfs            154M   1,1M  153M   1% /run
/dev/sda1         14G   5,8G  6,7G  47% /
tmpfs            768M      0  768M   0% /dev/shm
tmpfs            5,3M      0  5,3M   0% /run/lock
tmpfs            154M    62k  154M   1% /run/user/1000
root@debian:/home/lsi# apt autoclean
Leyendo lista de paquetes... Hecho
Creando árbol de dependencias... Hecho
Leyendo la información de estado... Hecho
root@debian:/home/lsi# apt clean
root@debian:/home/lsi# apt autoremove
Leyendo lista de paquetes... Hecho
Creando árbol de dependencias... Hecho
Leyendo la información de estado... Hecho
0 actualizados, 0 nuevos se instalarán, 0 para eliminar y 0 no actualizados.
root@debian:/home/lsi# apt --purge autoremove
Leyendo lista de paquetes... Hecho
Creando árbol de dependencias... Hecho
Leyendo la información de estado... Hecho
0 actualizados, 0 nuevos se instalarán, 0 para eliminar y 0 no actualizados.
root@debian:/home/lsi# uname -r
6.1.0-12-amd64
root@debian:/home/lsi# dpkg --list | grep linux-image
ii  linux-image-4.19.0-25-amd64             4.19.289-2                              amd64        Linux 4.19 for 64-bit PCs (signed)
rc  linux-image-4.19.0-9-amd64              4.19.118-2+deb10u1                      amd64        Linux 4.19 for 64-bit PCs (signed)
rc  linux-image-5.10.0-25-amd64             5.10.191-1                              amd64        Linux 5.10 for 64-bit PCs (signed)
ii  linux-image-6.1.0-12-amd64              6.1.52-1                                amd64        Linux 6.1 for 64-bit PCs (signed)
ii  linux-image-amd64                       6.1.52-1                                amd64        Linux for 64-bit PCs (meta-package)
root@debian:/home/lsi# apt-get --purge remove linux-image-4.19.0-9-amd64
Leyendo lista de paquetes... Hecho
Creando árbol de dependencias... Hecho
Leyendo la información de estado... Hecho
Los siguientes paquetes se ELIMINARÁN:
  linux-image-4.19.0-9-amd64*
0 actualizados, 0 nuevos se instalarán, 1 para eliminar y 0 no actualizados.
Se utilizarán 0 B de espacio de disco adicional después de esta operación.
¿Desea continuar? [S/n] S
(Leyendo la base de datos ... 160230 ficheros o directorios instalados actualmente.)
Purgando ficheros de configuración de linux-image-4.19.0-9-amd64 (4.19.118-2+deb10u1) ...
root@debian:/home/lsi# apt-get --purge remove linux-image-4.19.0-25-amd64
Leyendo lista de paquetes... Hecho
Creando árbol de dependencias... Hecho
Leyendo la información de estado... Hecho
Los siguientes paquetes se ELIMINARÁN:
  linux-image-4.19.0-25-amd64*
0 actualizados, 0 nuevos se instalarán, 1 para eliminar y 0 no actualizados.
Se liberarán 270 MB después de esta operación.
¿Desea continuar? [S/n] S
(Leyendo la base de datos ... 160229 ficheros o directorios instalados actualmente.)
Desinstalando linux-image-4.19.0-25-amd64 (4.19.289-2) ...
I: /vmlinuz.old is now a symlink to boot/vmlinuz-6.1.0-12-amd64
I: /initrd.img.old is now a symlink to boot/initrd.img-6.1.0-12-amd64
/etc/kernel/postrm.d/initramfs-tools:
update-initramfs: Deleting /boot/initrd.img-4.19.0-25-amd64
/etc/kernel/postrm.d/zz-update-grub:
Generating grub configuration file ...
Found background image: /usr/share/images/desktop-base/desktop-grub.png
Found linux image: /boot/vmlinuz-6.1.0-12-amd64
Found initrd image: /boot/initrd.img-6.1.0-12-amd64
Warning: os-prober will not be executed to detect other bootable partitions.
Systems on them will not be added to the GRUB boot configuration.
Check GRUB_DISABLE_OS_PROBER documentation entry.
done
(Leyendo la base de datos ... 155832 ficheros o directorios instalados actualmente.)
Purgando ficheros de configuración de linux-image-4.19.0-25-amd64 (4.19.289-2) ...
root@debian:/home/lsi# apt-get --purge remove linux-image-5.10.0-25-amd64
Leyendo lista de paquetes... Hecho
Creando árbol de dependencias... Hecho
Leyendo la información de estado... Hecho
Los siguientes paquetes se ELIMINARÁN:
  linux-image-5.10.0-25-amd64*
0 actualizados, 0 nuevos se instalarán, 1 para eliminar y 0 no actualizados.
Se utilizarán 0 B de espacio de disco adicional después de esta operación.
¿Desea continuar? [S/n] S
(Leyendo la base de datos ... 155831 ficheros o directorios instalados actualmente.)
Purgando ficheros de configuración de linux-image-5.10.0-25-amd64 (5.10.191-1) ...

```
</details>
<details>
<summary>
e) Instale el SIEM splunk en su máquina. Sobre dicha plataforma haga los siguientes puntos.:
</summary>
	
- Instalar Splunk
```console
root@ivan:/home/lsi# dpkg -i splunk-9.3.1-0b8d769cb912-linux-2.6-amd64.deb 
```
- Configurar para que se inice automaticamente
```console
root@ivan:/# /opt/splunk/bin/splunk enable boot-start
....
Please enter an administrator username: lsi
....
Please enter a new password: ivan.lsi
...
Init script installed at /etc/init.d/splunk.
Init script is configured to run at boot.
```
- Iniciamos el servicio en el sistema
```console
root@ivan:/# /etc/init.d/splunk start
....
root@ivan:/# systemctl start splunk.service
```
- Configuramos mindisk


<details>
	<summary> a. Genere una query que visualice los logs internos del splunk
		- Click en Search & reporting
		- Y en la barra buscadora : index="_internal" sourcetype="splunkd"
	</summary>
</details>

<details>
	<summary> b. Cargué el fichero /var/log/apache2/access.log y el journald del sistema y visualícelos.
		- index=main source="/var/log/apache2/access.log" | timechart count
	</summary>
</details>

<details>
	<summary> c. Obtenga las IPs de los equipos que se han conectado a su servidor web (pruebe a generar algún tipo de gráfico de visualización), así como las IPs que se han conectado un determinado día de un determinado mes.		
		- index=main source="/var/log/apache2/access.log"
			| where _time >= strptime("2024-10-03", "%Y-%m-%d") AND _time < strptime("2024-10-04", "%Y-%m-%d")
			| stats count by clientip
	</summary>
</details>

<details>
	<summary>
		d. Trate de obtener el país y región origen de las IPs que se han conectado a su servidor web y si posible sus coordenadas geográficas.	
	</summary>

 1.  Stats
			index=main source="/var/log/apache2/access.log"
				| stats count by clientip
				| iplocation clientip
				| table clientip, Country, Region, City, count
			index=main source="/var/log/apache2/access.log"
				| stats count by clientip
				| iplocation clientip
				| table clientip, Country, Region, City, latitude, longitude, count

 2.  Mapa (Dashboard)
    
		
		index=main source="/var/log/apache2/access.log"
		| stats count by clientip
		| iplocation clientip
		| geostats count by Country
</details>

 <details>
	 <summary>
		 e. Obtenga los hosts origen, sources y sourcestypes.
	 </summary>
	 index=main source="/var/log/apache2/access.log"
	| stats count by host, source, sourcetype
	| sort - count
 </details>
 
 <details>
	 <summary>
		f. ¿cómo podría hacer que splunk haga de servidor de log de su cliente?
	 </summary>
 </details>
</details>




